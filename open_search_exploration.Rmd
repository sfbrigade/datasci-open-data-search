---
title: "Open Search Exploration"
author: "Scott Brenstuhl"
date: "August 10, 2016"
output: html_document

---
       md_document:
        variant: markdown_github
        
```{r libraries, alert=FALSE, message = FALSE, echo = FALSE}
library(readr)
library(tidyr)
library(dplyr)
library(ggplot2)
```


```{r echo = FALSE}
queries <- read_csv("data/all_queries.csv")

# Check what these errors are from
problems(queries)

# We should remove these weird rows
# Did every sheet that got combined create one?
View(tail(queries))

```

## Understanding the Data
This data is coming from Google analytics "Site Search" functionality, which is
hooked up to the SF Open Data portal's search page. 

A lot of the useful information about this can be found at: 
https://developers.google.com/analytics/devguides/reporting/core/dimsmets



#### ga.searchKeyword(Search Terms)

These are the words and keywords that have been entered into the search form at
https://data.sfgov.org/



#### ga.searchStartPage(Search Page) 

Page on site where the user enters terms for a web search

```{r}
# Do we need to multiply these by the searchUnique column for accurate counts?
top20 <- table(queries$ga.searchStartPage) %>%
    sort(decreasing = TRUE) %>%
    head(20) %>%
    as.data.frame.table()

names(top20) <- c('start_page', 'visits')

ggplot(aes(x = start_page, y = visits), data = top20) +
    geom_point()

```

- Worth also exploring based on page category (dropping everything after the 
second slash)


#### ga.searchAfterDestinationPage(Search Destination Page)

The page that users visited after performing an internal search on the site.

```{r, echo=FALSE}
head(unique(queries$ga.searchAfterDestinationPage),100)


```


#### ga.searchUniques(Total Unique Searches)

The total number of times your site search was used. This excludes multiple 
searches on the same keyword during the same session.

Oddly the most common number of searches is 0 (if it's been 0 times how is it 
here??)

```{r, echo = FALSE}
head(table(queries$ga.searchUniques),10)

# Check that every term in filter(queries,ga.searchUniques == 0) has a counterpart with 1+ searches


```

Additional theory: Clicking back to a search page reruns and counts as a new 
search


#### ga.avgSearchResultViews(Results Pageviews / Search)

The average number of times people viewed a page as a result of a search.



#### ga.avgSearchDepth(Average Search Depth)

The average number of pages people viewed after performing a search.



#### ga.percentSearchRefinements(Search Refinements)

The percentage of the number of times a refinement (i.e., transition) occurs 
between internal keywords search within a session.



#### ga.searchDuration(Time after Search)

The session duration when the site's internal search feature is used.



#### ga.searchExitRate(Search Exits)

The percentage of searches that resulted in an immediate exit from the property.

- What is the difference between searchAfterDestinationPage == (exit) and 
searchExitRate == 100?

```{r}
filter(queries,ga.searchAfterDestinationPage == '(exit)')
```

