---
title: "Usage of the SF Data Portal"
output: html_document
---

```{r global_options, include=FALSE}
knitr::opts_chunk$set(fig.width=12, fig.height=8, fig.path='Figs/',
                      echo=FALSE, warning=FALSE, message=FALSE)
```

```{r libraries}
require(tidyverse)
require(stringr)
```

```{r import_data}
searches <- read_csv("processed_search_term_data/all_queries_w_search_type.csv")
searches <- searches[-1]
# Some summary data rows snuck into the processed file, this removes them
searches <- filter(searches, !is.na(ga.searchStartPage))
```


```{r}
# how does google analytics measure sessions?

unique_searches <- sum(searches$ga.searchUniques,na.rm = TRUE)

same_search <- nrow(filter(searches, ga.searchUniques == 0))

same_unique_ratio <- same_search/unique_searches

```

_below wording could be improved_  
One of the imediately interesting things about the data is how often people
are searching the same term multiple times in one session. We can sum all of the 
unique search counts and take the timese that ga.searchUniques equals 0 and see that
a search is at least `r round(same_unique_ratio, 2) * 100`% as likely to be a 
reran search as to be new for the user durring the session. In reality this is 
likely even more common because ga.searchUniques
does not increase if multiple people have made multiple searches for a term with all the 
other variables also being the same.




```{r search_origination}
searches$startSearchRoot <- gsub('\\?.*', '', searches$ga.searchStartPage) %>%
                            gsub("'\\/", '', .) %>%
                            gsub("\\/.*", '', .)

start_page_root <- searches %>%
                    group_by(startSearchRoot) %>%
                    summarise(Count = sum(ga.searchUniques)) %>%
                    arrange(desc(Count) )


unique_start_pages <- length(unique(searches$ga.searchStartPage)) 

top_search_roots <- head(start_page_root, 20) 

```

Searches originate from `r round(unique_start_pages / 1000, 1)` thousand 
differnt urls, mostly due to previous search results and other metadata being 
appended to the url. Focusing on just the root domains brings us
down to `r nrow(start_page_root)`, with the vast majority of searches comeing
from the browse and entrance pages. 

```{r search_origination_plot}
# What is the difference between '' and (enterance)?
top_search_roots <- head(start_page_root, 20) 

ggplot(aes(x=reorder(startSearchRoot, -Count), y=Count), data = top_search_roots) +
        geom_bar(stat="identity") +
        theme(axis.text.x = element_text(angle = -45, hjust = 0))
```

Looking at just when users search for the same term multiple times in a session,
the data root domain jumps to the lead and all of the more specific catagories 
rise.

```{r re_search_origination_plot}

re_search_page_root <- filter(searches, ga.searchUniques == 0) %>%
                    group_by(startSearchRoot) %>%
                    summarise(Count = n()) %>%
                    arrange(desc(Count) )

top_re_search_roots <- head(re_search_page_root, 20) 

ggplot(aes(x=reorder(startSearchRoot, -Count), y=Count), data = top_re_search_roots) +
        geom_bar(stat="identity") +
        theme(axis.text.x = element_text(angle = -45, hjust = 0))
```

```{r}
search_start <- filter(searches, grepl("'/data\\?search=", ga.searchStartPage))

search_start$last_search <- gsub(".*(data\\?search=)", '', search_start$ga.searchStartPage) %>%
                                gsub("&.*", "", .) %>%
                                gsub("\\+", " ", .) %>%
                                gsub("^\\s+|\\s+$", "", .) %>%
                                gsub("  ", " ", .)

#table(search_start$ga.searchKeyword == search_start$last_search)

changed_search <- filter(search_start, !(ga.searchKeyword == last_search)) %>%
                    select(last_search, ga.searchKeyword)

write_csv(changed_search, 'data/changed_searches.csv')

searched_same <- sum(search_start$ga.searchKeyword == 
                         search_start$last_search) / nrow(search_start)

```

By seperating previous searches out of ga.searchStartPage we can look at what
was searched in succession. Shockingly to me, in 
`r round(searched_same, 2) * 100 `% of these cases people searched the same 
term again. For the other `r round(1-searched_same, 2) * 100`%, it's pretty 
interesting to see how people change their queries, which can be
viewed in the changed_searches.csv.



